<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics UI Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-100">
    <div id="analytics-root" class="container mx-auto px-4 py-8">
        <h1 class="text-2xl font-bold mb-6">Analytics UI Test</h1>
        <div id="analytics-component"></div>
    </div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Mock Events API for testing
        window.eventsAPI = {
            getAnalytics: async (filters = {}) => {
                // Simulate API delay
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                return {
                    success: true,
                    attendance_analytics: {
                        overall_stats: {
                            total_events: 15,
                            total_rsvps: 350,
                            total_attended: 280,
                            total_no_shows: 45,
                            overall_attendance_rate: 86.15
                        },
                        event_stats: [
                            {
                                event_id: 'park-cleanup-1',
                                event_title: 'Central Park Cleanup',
                                total_rsvps: 25,
                                attended: 20,
                                no_shows: 3,
                                attendance_rate: 86.96
                            }
                        ]
                    },
                    cancellation_analytics: {
                        overall_stats: {
                            total_rsvps: 350,
                            total_cancelled: 35,
                            cancellation_rate: 10.0
                        },
                        timing_patterns: {
                            same_day: 5,
                            within_24_hours: 12,
                            within_48_hours: 8,
                            within_week: 7,
                            more_than_week: 3,
                            unknown: 0
                        }
                    },
                    volunteer_analytics: {
                        total_volunteers: 150,
                        active_volunteers: 120,
                        repeat_volunteers: 80,
                        retention_rate: 53.33,
                        engagement_distribution: {
                            one_time: 70,
                            occasional: 50,
                            regular: 20,
                            frequent: 10
                        }
                    }
                };
            },
            exportEvents: async (format, filters) => {
                console.log('Mock export events:', format, filters);
                if (format === 'csv') {
                    return 'event_id,title,start_time\ntest-1,Test Event,2024-01-15T10:00:00Z';
                }
                return { events: [{ event_id: 'test-1', title: 'Test Event' }] };
            },
            exportVolunteers: async (format, filters) => {
                console.log('Mock export volunteers:', format, filters);
                if (format === 'csv') {
                    return 'email,full_name,total_rsvps\ntest@example.com,Test User,5';
                }
                return { volunteers: [{ email: 'test@example.com', full_name: 'Test User' }] };
            }
        };

        // Analytics Component (copied from admin interface)
        const AnalyticsComponent = () => {
            const [analyticsData, setAnalyticsData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [dateRange, setDateRange] = useState({
                start_date: '',
                end_date: ''
            });
            const [exportFormat, setExportFormat] = useState('json');

            useEffect(() => {
                loadAnalyticsData();
            }, [dateRange]);

            const loadAnalyticsData = async () => {
                try {
                    setLoading(true);
                    setError('');
                    
                    if (!window.eventsAPI) {
                        throw new Error('Events API not initialized');
                    }

                    const filters = {};
                    if (dateRange.start_date) filters.start_date = dateRange.start_date;
                    if (dateRange.end_date) filters.end_date = dateRange.end_date;

                    const data = await window.eventsAPI.getAnalytics(filters);
                    setAnalyticsData(data);
                } catch (err) {
                    console.error('Error loading analytics:', err);
                    setError(err.message || 'Failed to load analytics data');
                } finally {
                    setLoading(false);
                }
            };

            const handleExportEvents = async () => {
                try {
                    const filters = {
                        include_rsvp_stats: true,
                        ...dateRange
                    };
                    
                    const data = await window.eventsAPI.exportEvents(exportFormat, filters);
                    
                    if (exportFormat === 'csv') {
                        // Create and download CSV file
                        const blob = new Blob([data.body || data], { type: 'text/csv' });
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `events_export_${new Date().toISOString().split('T')[0]}.csv`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                    } else {
                        // Download JSON file
                        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `events_export_${new Date().toISOString().split('T')[0]}.json`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                    }
                } catch (err) {
                    console.error('Error exporting events:', err);
                    setError(err.message || 'Failed to export events');
                }
            };

            const handleExportVolunteers = async () => {
                try {
                    const filters = {
                        include_metrics: true
                    };
                    
                    const data = await window.eventsAPI.exportVolunteers(exportFormat, filters);
                    
                    if (exportFormat === 'csv') {
                        // Create and download CSV file
                        const blob = new Blob([data.body || data], { type: 'text/csv' });
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `volunteers_export_${new Date().toISOString().split('T')[0]}.csv`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                    } else {
                        // Download JSON file
                        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `volunteers_export_${new Date().toISOString().split('T')[0]}.json`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                    }
                } catch (err) {
                    console.error('Error exporting volunteers:', err);
                    setError(err.message || 'Failed to export volunteers');
                }
            };

            if (loading) {
                return React.createElement('div', {
                    className: "text-center py-8"
                }, [
                    React.createElement('div', {
                        key: 'spinner',
                        className: "inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"
                    }),
                    React.createElement('p', {
                        key: 'text',
                        className: "mt-2 text-gray-600"
                    }, 'Loading analytics...')
                ]);
            }

            if (error) {
                return React.createElement('div', {
                    className: "bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"
                }, [
                    React.createElement('p', { key: 'error' }, error),
                    React.createElement('button', {
                        key: 'retry',
                        onClick: loadAnalyticsData,
                        className: "mt-2 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700"
                    }, 'Retry')
                ]);
            }

            return React.createElement('div', { className: "space-y-6" }, [
                // Date Range Filter
                React.createElement('div', {
                    key: 'filters',
                    className: "bg-gray-50 p-4 rounded-lg"
                }, [
                    React.createElement('h4', {
                        key: 'title',
                        className: "text-lg font-semibold mb-4"
                    }, 'Filters & Export'),
                    React.createElement('div', {
                        key: 'controls',
                        className: "grid grid-cols-1 md:grid-cols-4 gap-4"
                    }, [
                        React.createElement('div', { key: 'start-date' }, [
                            React.createElement('label', {
                                key: 'label',
                                className: "block text-sm font-medium text-gray-700 mb-1"
                            }, 'Start Date'),
                            React.createElement('input', {
                                key: 'input',
                                type: 'date',
                                value: dateRange.start_date,
                                onChange: (e) => setDateRange(prev => ({ ...prev, start_date: e.target.value })),
                                className: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            })
                        ]),
                        React.createElement('div', { key: 'end-date' }, [
                            React.createElement('label', {
                                key: 'label',
                                className: "block text-sm font-medium text-gray-700 mb-1"
                            }, 'End Date'),
                            React.createElement('input', {
                                key: 'input',
                                type: 'date',
                                value: dateRange.end_date,
                                onChange: (e) => setDateRange(prev => ({ ...prev, end_date: e.target.value })),
                                className: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            })
                        ]),
                        React.createElement('div', { key: 'format' }, [
                            React.createElement('label', {
                                key: 'label',
                                className: "block text-sm font-medium text-gray-700 mb-1"
                            }, 'Export Format'),
                            React.createElement('select', {
                                key: 'select',
                                value: exportFormat,
                                onChange: (e) => setExportFormat(e.target.value),
                                className: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            }, [
                                React.createElement('option', { key: 'json', value: 'json' }, 'JSON'),
                                React.createElement('option', { key: 'csv', value: 'csv' }, 'CSV')
                            ])
                        ]),
                        React.createElement('div', {
                            key: 'export-buttons',
                            className: "flex space-x-2"
                        }, [
                            React.createElement('button', {
                                key: 'export-events',
                                onClick: handleExportEvents,
                                className: "bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm"
                            }, 'Export Events'),
                            React.createElement('button', {
                                key: 'export-volunteers',
                                onClick: handleExportVolunteers,
                                className: "bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm"
                            }, 'Export Volunteers')
                        ])
                    ])
                ]),

                // Analytics Cards
                analyticsData ? React.createElement('div', {
                    key: 'analytics-cards',
                    className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"
                }, [
                    // Attendance Analytics
                    analyticsData.attendance_analytics ? React.createElement('div', {
                        key: 'attendance',
                        className: "bg-blue-50 p-6 rounded-lg border border-blue-200"
                    }, [
                        React.createElement('h4', {
                            key: 'title',
                            className: "text-lg font-semibold text-blue-800 mb-2"
                        }, 'Attendance Rate'),
                        React.createElement('p', {
                            key: 'rate',
                            className: "text-3xl font-bold text-blue-600"
                        }, `${analyticsData.attendance_analytics.overall_stats.overall_attendance_rate}%`),
                        React.createElement('p', {
                            key: 'details',
                            className: "text-sm text-blue-600 mt-2"
                        }, `${analyticsData.attendance_analytics.overall_stats.total_attended} attended / ${analyticsData.attendance_analytics.overall_stats.total_attended + analyticsData.attendance_analytics.overall_stats.total_no_shows} total`)
                    ]) : null,

                    // Cancellation Analytics
                    analyticsData.cancellation_analytics ? React.createElement('div', {
                        key: 'cancellation',
                        className: "bg-red-50 p-6 rounded-lg border border-red-200"
                    }, [
                        React.createElement('h4', {
                            key: 'title',
                            className: "text-lg font-semibold text-red-800 mb-2"
                        }, 'Cancellation Rate'),
                        React.createElement('p', {
                            key: 'rate',
                            className: "text-3xl font-bold text-red-600"
                        }, `${analyticsData.cancellation_analytics.overall_stats.cancellation_rate}%`),
                        React.createElement('p', {
                            key: 'details',
                            className: "text-sm text-red-600 mt-2"
                        }, `${analyticsData.cancellation_analytics.overall_stats.total_cancelled} cancelled / ${analyticsData.cancellation_analytics.overall_stats.total_rsvps} total`)
                    ]) : null,

                    // Volunteer Analytics
                    analyticsData.volunteer_analytics ? React.createElement('div', {
                        key: 'volunteers',
                        className: "bg-green-50 p-6 rounded-lg border border-green-200"
                    }, [
                        React.createElement('h4', {
                            key: 'title',
                            className: "text-lg font-semibold text-green-800 mb-2"
                        }, 'Total Volunteers'),
                        React.createElement('p', {
                            key: 'count',
                            className: "text-3xl font-bold text-green-600"
                        }, analyticsData.volunteer_analytics.total_volunteers),
                        React.createElement('p', {
                            key: 'details',
                            className: "text-sm text-green-600 mt-2"
                        }, `${analyticsData.volunteer_analytics.active_volunteers} active`)
                    ]) : null,

                    // Retention Rate
                    analyticsData.volunteer_analytics ? React.createElement('div', {
                        key: 'retention',
                        className: "bg-purple-50 p-6 rounded-lg border border-purple-200"
                    }, [
                        React.createElement('h4', {
                            key: 'title',
                            className: "text-lg font-semibold text-purple-800 mb-2"
                        }, 'Retention Rate'),
                        React.createElement('p', {
                            key: 'rate',
                            className: "text-3xl font-bold text-purple-600"
                        }, `${analyticsData.volunteer_analytics.retention_rate}%`),
                        React.createElement('p', {
                            key: 'details',
                            className: "text-sm text-purple-600 mt-2"
                        }, `${analyticsData.volunteer_analytics.repeat_volunteers} repeat volunteers`)
                    ]) : null
                ]) : null,

                // Detailed Analytics Tables
                analyticsData ? React.createElement('div', {
                    key: 'detailed-analytics',
                    className: "grid grid-cols-1 lg:grid-cols-2 gap-6"
                }, [
                    // Cancellation Timing Patterns
                    analyticsData.cancellation_analytics && analyticsData.cancellation_analytics.timing_patterns ? React.createElement('div', {
                        key: 'timing-patterns',
                        className: "bg-white p-6 rounded-lg border"
                    }, [
                        React.createElement('h4', {
                            key: 'title',
                            className: "text-lg font-semibold mb-4"
                        }, 'Cancellation Timing Patterns'),
                        React.createElement('div', {
                            key: 'patterns',
                            className: "space-y-2"
                        }, Object.entries(analyticsData.cancellation_analytics.timing_patterns).map(([key, value]) =>
                            React.createElement('div', {
                                key: key,
                                className: "flex justify-between items-center py-2 border-b"
                            }, [
                                React.createElement('span', {
                                    key: 'label',
                                    className: "text-gray-700 capitalize"
                                }, key.replace('_', ' ')),
                                React.createElement('span', {
                                    key: 'value',
                                    className: "font-semibold text-gray-900"
                                }, value)
                            ])
                        ))
                    ]) : null,

                    // Volunteer Engagement Distribution
                    analyticsData.volunteer_analytics && analyticsData.volunteer_analytics.engagement_distribution ? React.createElement('div', {
                        key: 'engagement',
                        className: "bg-white p-6 rounded-lg border"
                    }, [
                        React.createElement('h4', {
                            key: 'title',
                            className: "text-lg font-semibold mb-4"
                        }, 'Volunteer Engagement Distribution'),
                        React.createElement('div', {
                            key: 'distribution',
                            className: "space-y-2"
                        }, Object.entries(analyticsData.volunteer_analytics.engagement_distribution).map(([key, value]) =>
                            React.createElement('div', {
                                key: key,
                                className: "flex justify-between items-center py-2 border-b"
                            }, [
                                React.createElement('span', {
                                    key: 'label',
                                    className: "text-gray-700 capitalize"
                                }, key.replace('_', ' ')),
                                React.createElement('span', {
                                    key: 'value',
                                    className: "font-semibold text-gray-900"
                                }, value)
                            ])
                        ))
                    ]) : null
                ]) : null
            ]);
        };

        // Render the component
        ReactDOM.render(React.createElement(AnalyticsComponent), document.getElementById('analytics-component'));
    </script>
</body>
</html>