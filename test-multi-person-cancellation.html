<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Multi-Person RSVP Cancellation</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .hidden { display: none; }
  </style>
</head>
<body class="bg-gray-100 p-8">
  <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-6">
    <h1 class="text-2xl font-bold mb-6">Multi-Person RSVP Cancellation Test</h1>
    
    <!-- Test Event RSVP Widget -->
    <div class="event-rsvp-widget" data-event-id="test-event-123" data-attendance-cap="15">
      <div class="mb-4">
        <h2 class="text-xl font-semibold">Test Event</h2>
        <p class="text-gray-600">Current RSVPs: <span class="rsvp-count">0</span> / <span class="rsvp-capacity">15</span></p>
        <p class="rsvp-status text-sm text-gray-500">15 spots left</p>
      </div>
      
      <button class="rsvp-toggle-button bg-eden-green hover:bg-green-700 text-white py-2 px-4 rounded">
        Sign Up
      </button>
      
      <div class="rsvp-success hidden mt-4 p-4 bg-green-100 text-green-700 border border-green-200 rounded"></div>
      <div class="rsvp-error hidden mt-4 p-4 bg-red-100 text-red-700 border border-red-200 rounded"></div>
    </div>
    
    <!-- Test Controls -->
    <div class="mt-8 p-4 bg-gray-50 rounded border border-gray-200">
      <h3 class="text-lg font-semibold mb-4">Test Controls</h3>
      
      <div class="space-y-2">
        <button onclick="setupTestAuth()" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded">
          1. Setup Test Authentication
        </button>
        
        <button onclick="setupTestMinors()" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded">
          2. Setup Test Minors
        </button>
        
        <button onclick="setupExistingRsvps()" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded">
          3. Setup Existing RSVPs (Mock)
        </button>
        
        <button onclick="triggerRsvpButton()" class="w-full bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded">
          4. Click RSVP Button
        </button>
        
        <button onclick="testCancelButton()" class="w-full bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded">
          5. Test Cancel Button
        </button>
      </div>
      
      <div class="mt-4 p-3 bg-white rounded border border-gray-300">
        <h4 class="font-semibold mb-2">Console Output:</h4>
        <div id="console-output" class="text-xs font-mono text-gray-700 max-h-40 overflow-y-auto"></div>
      </div>
    </div>
  </div>

  <!-- Load API Config -->
  <script>
    window.API_CONFIG = {
      BASE_URL: 'https://ppiqomgl8a.execute-api.us-east-1.amazonaws.com/staging',
      EVENT_RSVP_CHECK: 'https://ppiqomgl8a.execute-api.us-east-1.amazonaws.com/staging/check-event-rsvp',
      EVENT_RSVP_SUBMIT: 'https://ppiqomgl8a.execute-api.us-east-1.amazonaws.com/staging/submit-event-rsvp'
    };
  </script>

  <!-- Mock Auth Client -->
  <script>
    class AuthClient {
      constructor() {
        this.authenticated = false;
        this.email = null;
      }
      
      isAuthenticated() {
        return this.authenticated;
      }
      
      getUserEmail() {
        return this.email;
      }
      
      async getMinorsList() {
        const cached = sessionStorage.getItem('auth_minors_list');
        if (cached) {
          const data = JSON.parse(cached);
          return { success: true, minors: data.minors };
        }
        return { success: true, minors: [] };
      }
    }
    
    window.authClient = new AuthClient();
  </script>

  <!-- Load Event RSVP Script -->
  <script src="/static/js/event-rsvp.js"></script>

  <!-- Test Helper Functions -->
  <script>
    const log = (message) => {
      const output = document.getElementById('console-output');
      const timestamp = new Date().toLocaleTimeString();
      output.innerHTML += `[${timestamp}] ${message}<br>`;
      output.scrollTop = output.scrollHeight;
      console.log(message);
    };

    function setupTestAuth() {
      // Setup authentication
      window.authClient.authenticated = true;
      window.authClient.email = 'test@example.com';
      localStorage.setItem('auth_session_token', 'test-session-token-123');
      localStorage.setItem('auth_user_email', 'test@example.com');
      log('‚úÖ Authentication setup complete');
    }

    function setupTestMinors() {
      // Setup minors list
      const minors = [
        {
          minor_id: 'minor-1',
          first_name: 'Alice',
          last_name: 'Smith',
          age: 12
        },
        {
          minor_id: 'minor-2',
          first_name: 'Bob',
          last_name: 'Smith',
          age: 10
        }
      ];
      
      sessionStorage.setItem('auth_minors_list', JSON.stringify({
        minors: minors,
        timestamp: Date.now()
      }));
      
      log(`‚úÖ Setup ${minors.length} test minors`);
    }

    function setupExistingRsvps() {
      // Mock the checkEventRsvp function to return existing RSVPs
      const originalCheckEventRsvp = window.checkEventRsvp;
      
      window.checkEventRsvp = async function(eventId, email) {
        log('üì° Mock checkEventRsvp called');
        
        // Return mock data with existing RSVPs
        return {
          success: true,
          rsvp_count: 3,
          user_registered: true,
          user_rsvps: [
            {
              attendee_id: 'test@example.com',
              attendee_type: 'volunteer',
              first_name: 'Test',
              last_name: 'User',
              created_at: new Date().toISOString()
            },
            {
              attendee_id: 'minor-1',
              attendee_type: 'minor',
              first_name: 'Alice',
              last_name: 'Smith',
              age: 12,
              created_at: new Date().toISOString()
            }
          ]
        };
      };
      
      log('‚úÖ Mock existing RSVPs setup (volunteer + 1 minor)');
    }

    function triggerRsvpButton() {
      const button = document.querySelector('.rsvp-toggle-button');
      if (button) {
        button.click();
        log('‚úÖ RSVP button clicked');
      } else {
        log('‚ùå RSVP button not found');
      }
    }

    function testCancelButton() {
      // Wait a bit for the UI to render
      setTimeout(() => {
        const cancelButtons = document.querySelectorAll('.cancel-attendee-button');
        if (cancelButtons.length > 0) {
          log(`‚úÖ Found ${cancelButtons.length} cancel button(s)`);
          
          // Mock the cancelIndividualRsvp function
          window.cancelIndividualRsvp = async function(eventId, attendeeId, attendeeType) {
            log(`üì° Mock cancelIndividualRsvp called: ${attendeeType} ${attendeeId}`);
            
            return {
              success: true,
              message: 'RSVP cancelled successfully',
              attendee_id: attendeeId,
              attendee_type: attendeeType,
              hours_before_event: 48.5
            };
          };
          
          log('‚úÖ Mock cancellation API setup');
          log('‚ÑπÔ∏è Click a cancel button to test cancellation');
        } else {
          log('‚ùå No cancel buttons found. Make sure RSVPs are registered first.');
        }
      }, 500);
    }

    // Initialize on load
    window.addEventListener('DOMContentLoaded', () => {
      log('üöÄ Test page loaded');
      log('‚ÑπÔ∏è Follow the numbered buttons to test the cancellation flow');
    });
  </script>
</body>
</html>
