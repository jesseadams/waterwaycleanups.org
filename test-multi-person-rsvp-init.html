<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Multi-Person RSVP Initialization</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    .test-section h3 {
      margin-top: 0;
    }
    .success {
      background-color: #d4edda;
      border-color: #c3e6cb;
    }
    .error {
      background-color: #f8d7da;
      border-color: #f5c6cb;
    }
    .info {
      background-color: #d1ecf1;
      border-color: #bee5eb;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
    }
    .event-rsvp-widget {
      border: 2px solid #333;
      padding: 20px;
      margin: 20px 0;
    }
    .hidden {
      display: none;
    }
    .rsvp-success, .rsvp-error {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
    }
    .rsvp-success {
      background-color: #d4edda;
      color: #155724;
    }
    .rsvp-error {
      background-color: #f8d7da;
      color: #721c24;
    }
  </style>
</head>
<body>
  <h1>Multi-Person RSVP Initialization Test</h1>
  
  <div class="test-section info">
    <h3>Test Instructions</h3>
    <p>This page tests the enhanced RSVP widget initialization with minors list fetching.</p>
    <ol>
      <li>Open browser console to see detailed logs</li>
      <li>Click "Setup Mock Auth" to simulate authentication</li>
      <li>Click "Setup Mock Minors" to add test minors data</li>
      <li>Click "Initialize Widget" to test the initialization flow</li>
      <li>Check console for minors fetching and caching behavior</li>
    </ol>
  </div>

  <div class="test-section">
    <h3>Setup</h3>
    <button onclick="setupMockAuth()">Setup Mock Auth (No Minors)</button>
    <button onclick="setupMockAuthWithMinors()">Setup Mock Auth (With Minors)</button>
    <button onclick="clearAuth()">Clear Auth</button>
    <button onclick="clearMinorsCache()">Clear Minors Cache</button>
  </div>

  <div class="test-section">
    <h3>Test Widget</h3>
    <div class="event-rsvp-widget" data-event-id="test-event-123" data-attendance-cap="15">
      <div class="rsvp-status">Loading...</div>
      <div class="rsvp-count">0</div>
      <div class="rsvp-capacity">15</div>
      <button class="rsvp-toggle-button">Sign Up</button>
      <div class="rsvp-success hidden"></div>
      <div class="rsvp-error hidden"></div>
    </div>
  </div>

  <div class="test-section">
    <h3>Test Results</h3>
    <div id="test-results"></div>
  </div>

  <!-- Mock API Configuration -->
  <script>
    window.API_CONFIG = {
      BASE_URL: 'https://ppiqomgl8a.execute-api.us-east-1.amazonaws.com/staging',
      EVENT_RSVP_CHECK: 'https://ppiqomgl8a.execute-api.us-east-1.amazonaws.com/staging/check-event-rsvp',
      EVENT_RSVP_SUBMIT: 'https://ppiqomgl8a.execute-api.us-east-1.amazonaws.com/staging/submit-event-rsvp'
    };
  </script>

  <!-- Load Auth Client -->
  <script src="/static/js/auth-client.js"></script>

  <!-- Mock Auth Client Methods -->
  <script>
    // Store original getMinorsList method
    const originalGetMinorsList = window.authClient.getMinorsList.bind(window.authClient);

    // Override getMinorsList to return mock data
    window.authClient.getMinorsList = async function() {
      console.log('Mock getMinorsList called');
      
      // Check if we have mock minors in localStorage
      const mockMinors = localStorage.getItem('mock_minors');
      if (mockMinors) {
        const minors = JSON.parse(mockMinors);
        return {
          success: true,
          minors: minors,
          count: minors.length
        };
      }
      
      // Return empty list if no mock data
      return {
        success: true,
        minors: [],
        count: 0
      };
    };

    function setupMockAuth() {
      const expiry = new Date();
      expiry.setHours(expiry.getHours() + 1);
      
      localStorage.setItem('auth_session_token', 'mock-token-123');
      localStorage.setItem('auth_user_email', 'test@example.com');
      localStorage.setItem('auth_session_expiry', expiry.toISOString());
      localStorage.removeItem('mock_minors');
      
      // Reinitialize auth client
      window.authClient = new AuthClient();
      window.authClient.getMinorsList = async function() {
        return { success: true, minors: [], count: 0 };
      };
      
      logResult('✅ Mock auth setup (no minors)', 'success');
      console.log('Auth setup complete - no minors');
    }

    function setupMockAuthWithMinors() {
      const expiry = new Date();
      expiry.setHours(expiry.getHours() + 1);
      
      localStorage.setItem('auth_session_token', 'mock-token-123');
      localStorage.setItem('auth_user_email', 'test@example.com');
      localStorage.setItem('auth_session_expiry', expiry.toISOString());
      
      // Add mock minors
      const mockMinors = [
        {
          minor_id: 'minor-1',
          first_name: 'Alice',
          last_name: 'Smith',
          date_of_birth: '2015-05-15',
          age: 9,
          created_at: '2025-01-01T00:00:00Z'
        },
        {
          minor_id: 'minor-2',
          first_name: 'Bob',
          last_name: 'Smith',
          date_of_birth: '2012-08-20',
          age: 12,
          created_at: '2025-01-01T00:00:00Z'
        }
      ];
      localStorage.setItem('mock_minors', JSON.stringify(mockMinors));
      
      // Reinitialize auth client
      window.authClient = new AuthClient();
      window.authClient.getMinorsList = async function() {
        const minors = JSON.parse(localStorage.getItem('mock_minors') || '[]');
        return { success: true, minors: minors, count: minors.length };
      };
      
      logResult('✅ Mock auth setup (with 2 minors)', 'success');
      console.log('Auth setup complete - with minors:', mockMinors);
    }

    function clearAuth() {
      localStorage.removeItem('auth_session_token');
      localStorage.removeItem('auth_user_email');
      localStorage.removeItem('auth_session_expiry');
      localStorage.removeItem('mock_minors');
      sessionStorage.removeItem('auth_minors_list');
      
      window.authClient = new AuthClient();
      
      logResult('✅ Auth cleared', 'info');
      console.log('Auth cleared');
    }

    function clearMinorsCache() {
      sessionStorage.removeItem('auth_minors_list');
      logResult('✅ Minors cache cleared', 'info');
      console.log('Minors cache cleared');
    }

    function logResult(message, type) {
      const resultsDiv = document.getElementById('test-results');
      const resultItem = document.createElement('div');
      resultItem.className = `test-section ${type}`;
      resultItem.innerHTML = `<p>${message}</p>`;
      resultsDiv.appendChild(resultItem);
    }

    // Test initialization
    async function testInitialization() {
      console.log('=== Testing Widget Initialization ===');
      
      const widget = document.querySelector('.event-rsvp-widget');
      if (!widget) {
        logResult('❌ Widget not found', 'error');
        return;
      }

      try {
        // Clear any existing cache
        sessionStorage.removeItem('auth_minors_list');
        
        // Call initialization
        await initializeRsvpWidget(widget);
        
        // Check if minors were fetched and cached
        const cachedMinors = sessionStorage.getItem('auth_minors_list');
        if (cachedMinors) {
          const cached = JSON.parse(cachedMinors);
          logResult(`✅ Minors cached: ${cached.minors.length} minors`, 'success');
          console.log('Cached minors:', cached);
        } else {
          logResult('✅ No minors cached (user has no minors)', 'success');
        }
        
        logResult('✅ Widget initialized successfully', 'success');
      } catch (error) {
        logResult(`❌ Initialization failed: ${error.message}`, 'error');
        console.error('Initialization error:', error);
      }
    }

    // Add button to trigger test
    document.addEventListener('DOMContentLoaded', () => {
      const testSection = document.querySelector('.test-section:last-of-type');
      const testButton = document.createElement('button');
      testButton.textContent = 'Initialize Widget';
      testButton.onclick = testInitialization;
      testSection.insertBefore(testButton, testSection.querySelector('#test-results'));
    });
  </script>

  <!-- Load Event RSVP Script -->
  <script src="/static/js/event-rsvp.js"></script>
</body>
</html>
